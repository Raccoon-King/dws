{{- if .Values.tests.enabled }}
apiVersion: v1
kind: Pod
metadata:
  name: "{{ include "dws.fullname" . }}-test-connection"
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "dws.labels" . | nindent 4 }}
    app.kubernetes.io/component: test
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-weight": "1"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  restartPolicy: Never
  securityContext:
    runAsNonRoot: true
    runAsUser: 65534
    runAsGroup: 65534
    fsGroup: 65534
  containers:
    - name: test-connection
      image: {{ .Values.tests.image.registry }}/{{ .Values.tests.image.repository }}:{{ .Values.tests.image.tag }}
      securityContext:
        allowPrivilegeEscalation: false
        capabilities:
          drop:
            - ALL
        readOnlyRootFilesystem: true
        runAsNonRoot: true
        runAsUser: 65534
      resources:
        {{- toYaml .Values.tests.resources | nindent 8 }}
      command:
        - /bin/sh
        - -c
        - |
          set -e
          echo "Testing DWS health endpoint..."

          # Test health endpoint
          curl -f http://{{ include "dws.fullname" . }}:{{ .Values.service.port }}/health
          echo "âœ… Health check passed"

          # Test docs endpoint
          curl -f http://{{ include "dws.fullname" . }}:{{ .Values.service.port }}/docs
          echo "âœ… Documentation endpoint accessible"

          echo "ðŸŽ‰ All connection tests passed!"
{{- end }}